generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String  @id @default(cuid())
  email          String  @unique
  name           String?
  hashedPassword String?
  image          String?
  
  // Onboarding
  sector           String?
  teamSize         String?
  processVolume    String?

  pieces           Piece[]
  favoriteTemplates FavoriteTemplate[]
  suggestions      Suggestion[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Template {
  id          String   @id @default(cuid())
  category    String
  title       String
  description String
  tags        String[] // e.g. ["Popular", "Civil"]
  isPopular   Boolean  @default(false)
  
  // JSON structures for the Wizard
  schemaCampos Json? // Zod schema definition for dynamic fields if needed
  promptBase   String? // The base prompt for the AI
  
  pieces            Piece[]
  favoritedBy       FavoriteTemplate[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Piece {
  id          String   @id @default(cuid())
  userId      String
  templateId  String
  
  status      String   @default("draft") // draft, generating, completed
  title       String?

  // Wizard Data
  inputsJson  Json?    // Step A, C, D inputs
  thesesJson  Json?    // Step B/E selected theses
  jurisJson   Json?    // Step F selected juris
  
  // Editor Content
  contentJson Json?    // TipTap JSON content
  
  user        User     @relation(fields: [userId], references: [id])
  template    Template @relation(fields: [templateId], references: [id])
  
  versions       PieceVersion[]
  exports        Export[]
  feedbacks      Feedback[]
  aiSuggestions  AiSuggestion[]
  validationRuns ValidationRun[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PieceVersion {
  id           String   @id @default(cuid())
  pieceId      String
  contentJson  Json
  changeReason String?  // ai_suggestion | validation | export | manual
  
  piece          Piece          @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  aiSuggestions  AiSuggestion[]
  validationRuns ValidationRun[]
  exports        Export[]
  
  createdAt    DateTime @default(now())
}

model FavoriteTemplate {
  userId     String
  templateId String

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@id([userId, templateId])
}

model Export {
  id              String   @id @default(cuid())
  pieceId         String
  type            String   // PDF, DOCX, TXT
  fileUrl         String
  pieceVersionId  String?
  validationRunId String?
  includeWarnings Boolean  @default(false)
  metaJson        Json?    // {pendingCount, citationCount, etc}
  
  piece           Piece          @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  pieceVersion    PieceVersion?  @relation(fields: [pieceVersionId], references: [id])
  validationRun   ValidationRun? @relation(fields: [validationRunId], references: [id])
  
  createdAt       DateTime @default(now())
}

model Feedback {
  id        String   @id @default(cuid())
  pieceId   String
  rating    Int
  comment   String?
  
  piece     Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model Suggestion {
  id        String   @id @default(cuid())
  userId    String
  text      String
  
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
}

// Phase 1: AI Suggestions
model AiSuggestion {
  id             String   @id @default(cuid())
  pieceId        String
  pieceVersionId String?
  actionType     String   // rewrite | formalize | reduce | cohesion | fundamentation
  selectionFrom  Int      // TipTap position start
  selectionTo    Int      // TipTap position end
  originalText   String
  suggestedText  String
  status         String   @default("pending") // pending | accepted | rejected
  
  piece          Piece         @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  pieceVersion   PieceVersion? @relation(fields: [pieceVersionId], references: [id])
  
  createdAt      DateTime @default(now())
}

// Phase 2: Validation
model ValidationRun {
  id             String   @id @default(cuid())
  pieceId        String
  pieceVersionId String
  status         String   @default("queued") // queued | running | done | failed
  summaryJson    Json?
  
  piece          Piece        @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  pieceVersion   PieceVersion @relation(fields: [pieceVersionId], references: [id])
  pendingItems   PendingItem[]
  citations      Citation[]
  exports        Export[]
  
  createdAt      DateTime @default(now())
}

model PendingItem {
  id              String   @id @default(cuid())
  validationRunId String
  type            String   // checklist | citation | inconsistency
  title           String
  description     String?
  severity        String   @default("info") // info | warn | blocker
  status          String   @default("open") // open | resolved | ignored
  anchorJson      Json?    // {from, to} position in document
  
  validationRun   ValidationRun @relation(fields: [validationRunId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
}

model Citation {
  id              String   @id @default(cuid())
  validationRunId String
  rawText         String
  kind            String   // lei | sumula | julgado | outro
  normalized      String?
  confidence      Float?
  status          String   @default("unverified") // unverified | verified | suspect
  anchorJson      Json?
  
  validationRun   ValidationRun @relation(fields: [validationRunId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
}
